<div class="row mt-5">
    <div class="col-6">
        <h5 class="fw-bold">Resume Medik</h5>
    </div>
    <div class="col-6 d-flex justify-content-end gap-2 align-items-center">
        <label for="" class="col-3">Ruang poliklinik</label>
        <input type="text" name="nama_poli" class="form-control border-dark">
    </div>

    <ol class="form-check my-2">
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">No kartu BPJS</label>
                <input type="text" class="form-control border-dark" name="no_bpjs">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Nama Rs</div>
                    <div class="fst-italic">Hospital Name</div>
                </label>
                <input type="text" class="form-control border-dark" name="hospital" value="RSU WIRA HUSADA KISARAN" disabled>
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>No Kode Rs</div>
                    <div class="fst-italic">Hospital Code Number</div>
                </label>
                <input type="text" class="form-control border-dark" name="hospital_code" value="028R010" disabled>
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Kelas Rs</div>
                    <div class="fst-italic">Type Of Hospital</div>
                </label>
                <input type="text" class="form-control border-dark" name="hospital_type" value="'D'" disabled>
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>No Rekam Medik</div>
                    <div class="fst-italic">Pasien Record Number</div>
                </label>
                <input type="text" class="form-control border-dark" name="no_rm">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Nama Pasien</div>
                    <div class="fst-italic">Pasien Name</div>
                </label>
                <input type="text" class="form-control border-dark" name="nama_pasien">
            </div>
        </li>
        <table class="table table-borderless">
            <tbody>
                <tr>
                    <td>
                        <li>
                            <div class="my-1 d-flex align-items-center gap-2">
                                <label for="" class="col-4">
                                    <div class="flex-shrink-0">Jenis perawatan</div>
                                    <div class="fst-italic">Patien Type Desigination</div>
                                </label>
                                <input type="text" class="form-control border-dark" name="jenis_perawatan">
                            </div>
                        </li>
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-2">
                            <div>1. Rawat Inap/inpatient Care</div>
                            <div>2. Rawat jalan/outpatien Care</div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Kelas Perawatan</div>
                    <div class="fst-italic">Type of Class</div>
                </label>
                <input type="text" class="form-control border-dark" name="kelas">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Total Biaya</div>
                    <div class="fst-italic">total Changers</div>
                </label>
                <input type="text" class="form-control border-dark" name="biaya">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Tanggal Masuk</div>
                    <div class="fst-italic">Admission Date</div>
                </label>
                <input type="text" class="form-control border-dark" name="tgl_admit">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Tanggal Keluar</div>
                    <div class="fst-italic">Discharge Date</div>
                </label>
                <input type="text" class="form-control border-dark" name="tgl_discharge">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Jumlah Hari Perawatan</div>
                    <div class="fst-italic">Length Of Stay</div>
                </label>
                <input type="text" class="form-control border-dark" name="jumlah_hari_perawatan">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Tanggal Lahir</div>
                    <div class="fst-italic">Birth Date</div>
                </label>
                <input type="text" class="form-control border-dark" name="tanggal_lahir">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Usia </div>
                    <div class="fst-italic">Admission Age in Years</div>
                </label>
                <input type="text" class="form-control border-dark" name="umur">
            </div>
        </li>
        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Jenis Kelamin </div>
                    <div class="fst-italic">Gender</div>
                </label>
                <input type="text" class="form-control border-dark" name="jenkel">
            </div>
        </li>
        <table class="table table-borderless">
            <tbody>
                <tr>
                    <td>
                        <li>
                            <div class="my-1 d-flex align-items-center gap-2">
                                <label for="" class="col-4">
                                    <div class="flex-shrink-0">Cara Pulang</div>
                                    <div class="fst-italic">Discharge Disposition</div>
                                </label>
                                <input type="text" class="form-control border-dark" name="cara_pulang">
                            </div>
                        </li>
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-2">
                            <div>1. belum sembuh</div>
                            <div>2. sembuh</div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Berat Lahir (Grams)</div>
                    <div class="fst-italic">Birth Weight(Grams)</div>
                </label>
                <input type="text" class="form-control border-dark" name="berat">
            </div>
        </li>

        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Diagnosa Utama</div>
                    <div class="fst-italic">Principal Diagnosis </div>
                </label>
               <!--  <select type="select" name="diagnosa_utama" id="diagnosa_utama" class="form-select diagnosa">
                </select> -->
                <textarea name="diagnosa_utama" class="form-control border-dark" rows="2"></textarea>
            </div>
        </li>

        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-2">
                    <div>Kode Diagnosa Utama</div>
                    <div class="fst-italic">Principal Diagnosis Code</div>
                </label>
                <select type="select" name="kode_diagnosa_utama" id="kode_diagnosa_utama" class="form-select diagnosa">
                </select>
            </div>
        </li>

        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-3">
                    <div>Kode Diagnosa Sekunder</div>
                    <div class="fst-italic">Principal diagnosis code</div>
                </label>
            </div>
        </li>

        <table class="table table-bordered border-dark">
            <tbody>
                <tr class="text-center">
                    <td class="col-1">No</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="col-5">Kode</div>
                            <div class="col-1">|</div>
                            <div class="col-5">Diagnosa</div>
                        </div>
                    </td>
                </tr>
                <?php for ($i = 1; $i <= 4; $i++): ?>
                    <tr>
                        <td class="text-center"><?= $i; ?></td>
                        <td> <select type="select" name="diagnosa_sekunder_<?= $i; ?>" id="diagnosa_sekunder_<?= $i; ?>" class="form-select diagnosa" style="width: 100%;">
                            </select></td>
                    </tr>
                <?php endfor; ?>

            </tbody>
        </table>


        <li>
            <div class="my-2 d-flex align-items-center gap-2">
                <label for="" class="col-3">
                    <div>Kode Tindakan</div>
                    <div class="fst-italic">Proceurres Code</div>
                </label>
            </div>
        </li>

        <table class="table table-bordered border-dark">
            <tbody>
                <tr class="text-center">
                    <td class="col-1">No</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="col-5">Kode</div>
                            <div class="col-1">|</div>
                            <div class="col-5">Diagnosa</div>
                        </div>
                    </td>
                </tr>
                <?php for ($i = 1; $i <= 8; $i++): ?>
                    <tr>
                        <td class="text-center"><?= $i; ?></td>
                        <td>
                            <select type="select" name="diagnosa_tindakan_<?= $i; ?>" id="diagnosa_tindakan_<?= $i; ?>" class="form-select diagnosa9" style="width: 100%;"></select>
                        </td>
                    </tr>
                <?php endfor; ?>

            </tbody>
        </table>
    </ol>
</div>

<div class="d-flex justify-content-end flex-column align-items-end">
    <div class="d-flex align-items-center gap-2">
        <div class="flex-shrink-0"><?= $city_sign; ?>,</div>
        <input type="text" name="tgl_admit2" id="" class="form-control border-dark" value="<?= date('Y-m-d', strtotime($tgl_admit2)) ?>" readonly>
    </div>
    <div class="my-2">Dokter Penanggung Jawab</div>
    <div class="text-end">
        <img class="img-responsive center-block mt-2" style="width: 10%;" id="qr_dokter_dpjp" />
    </div>
    <div class="mt-2 d-flex gap-2 align-items-center">
        <label for="" class="flex-shrink-0"></label>
        <input type="text" name="nama_dokter" class="form-control border-dark" style="width:350px;">
    </div>
</div>

<script>
    let dataDokter = []
    const mode = "<?= $mode; ?>"

    $(document).ready(function() {
        let page = 1;
        $('.diagnosa').select2({
            ajax: {
                url: '<?= site_url('backend/admission/getDiagnosa'); ?>', // PHP script to fetch data
                dataType: 'json',
                delay: 250, // Delay in ms while typing
                data: function(params) {
                    // Send search term, limit, and offset
                    return {
                        q: params.term, // Search query
                        limit: 100, // Number of items per page
                        offset: (page - 1) * 100, // Calculate offset based on the page
                    };
                },
                processResults: function(data) {
                    console.log(data)
                    const {
                        items,
                        more
                    } = data.data;

                    return {
                        results: items, // Data from PHP
                        pagination: {
                            more: more, // Check if more data is available
                        },
                    };
                },
                cache: true,
            },
            placeholder: 'cari nama diagnosa',
        });

        // Handle scroll to load more data
        $('.diagnosa').on('select2:open', function() {
            $('.select2-results__options').on('scroll', function() {
                const $this = $(this);
                if ($this.scrollTop() + $this.innerHeight() >= $this[0].scrollHeight) {
                    if (page > 0) { // Check if more pages are available
                        page++; // Increment page
                        $('.diagnosa').select2('open'); // Keep dropdown open
                        $('.diagnosa').select2('data', null); // Clear current data
                    }
                }
            });
        });

        /// AMBIL CODE ICD 9
        $('.diagnosa9').select2({
            ajax: {
                url: '<?= site_url('backend/admission/getDiagnosa9'); ?>', // PHP script to fetch data
                dataType: 'json',
                delay: 250, // Delay in ms while typing
                data: function(params) {
                    // Send search term, limit, and offset
                    return {
                        q: params.term, // Search query
                        limit: 100, // Number of items per page
                        offset: (page - 1) * 100, // Calculate offset based on the page
                    };
                },
                processResults: function(data) {
                    console.log(data)
                    const {
                        items,
                        more
                    } = data.data;

                    return {
                        results: items, // Data from PHP
                        pagination: {
                            more: more, // Check if more data is available
                        },
                    };
                },
                cache: true,
            },
            placeholder: 'cari kode tindakan',
        });

        // Handle scroll to load more data
        $('.diagnosa9').on('select2:open', function() {
            $('.select2-results__options').on('scroll', function() {
                const $this = $(this);
                if ($this.scrollTop() + $this.innerHeight() >= $this[0].scrollHeight) {
                    if (page > 0) { // Check if more pages are available
                        page++; // Increment page
                        $('.diagnosa9').select2('open'); // Keep dropdown open
                        $('.diagnosa9').select2('data', null); // Clear current data
                    }
                }
            });
        });



        /// AMBIL CODE ICD 9

        const globalData = <?= $global_data; ?>;
        const {
            id_dokter,
            id_perawat,
            nama_perawat
        } = globalData;

        listDokterUmumAPI()


        QRSignatureAPI(id_dokter, 'qr_dokter_dpjp')

        $('#dokter_umum').on('select2:select', function(e) {
            const {
                id_original
            } = e.params.data;
            QRSignatureAPI(id_original, 'qr_dokter_umum')
        });

        // mulai aktif jumlah dokter pemeriksaan
        const jumlahDokterpemeriksaan = 30;

        for (let i = 1; i <= jumlahDokterpemeriksaan; i++) {
            $(`#dokter_pemeriksaan${i}`).on('select2:select', function(e) {
                const {
                    id_original
                } = e.params.data;
                QRSignatureAPI(id_original, `qr_dokter_pemeriksaan${i}`);
            });
        }

        $('#dokter_pemeriksaan').on('select2:select', function(e) {
            const {
                id_original
            } = e.params.data;
            QRSignatureAPI(id_original, 'qr_dokter_pemeriksaan')
        });


        // mulai aktif jumlah dokter diagnostik
        const jumlahDokterdiagnostik = 30;

        for (let i = 1; i <= jumlahDokterdiagnostik; i++) {
            $(`#dokter_diagnostik${i}`).on('select2:select', function(e) {
                const {
                    id_original
                } = e.params.data;
                QRSignatureAPI(id_original, `qr_dokter_diagnostik${i}`);
            });
        }

        $('#dokter_diagnostik').on('select2:select', function(e) {
            const {
                id_original
            } = e.params.data;
            QRSignatureAPI(id_original, 'qr_dokter_diagnostik')
        });


        // mulai aktif jumlah dokter penunjang
        const jumlahDokterpenunjang = 30;

        for (let i = 1; i <= jumlahDokterpenunjang; i++) {
            $(`#dokter_penunjang${i}`).on('select2:select', function(e) {
                const {
                    id_original
                } = e.params.data;
                QRSignatureAPI(id_original, `qr_dokter_penunjang${i}`);
            });
        }

        $('#dokter_penunjang').on('select2:select', function(e) {
            const {
                id_original
            } = e.params.data;
            QRSignatureAPI(id_original, 'qr_dokter_penunjang')
        });


        $('#dokter_umum').prop('disabled', false)
        $('#dokter_umum').select2('open')
        $('#dokter_umum').select2('close')
        if (mode === "lihat")
            $('#dokter_umum').prop('disabled', true)

        setTimeout(() => {
            console.log(dataDokter)
            dataDokter?.map(v => {
                if (v.text === $('#dokter_umum').select2('data')[0].text) {
                    QRSignatureAPI(v.id_original, 'qr_dokter_umum')
                }
            })
        }, 1000)
    });


    $(document).delay(1000).queue(function() {
        callMarkerManager();
    });

    function cbCommon(data) {

        populateFormFields(data);


        // dokter img pemeriksaan
        const jumlahDokterpemeriksaan = 30;

        for (let i = 1; i <= jumlahDokterpemeriksaan; i++) {
            const dokterSelect = `#dokter_pemeriksaan${i}`;
            const qrId = `qr_dokter_pemeriksaan${i}`;

            $(dokterSelect).prop('disabled', false).select2('open').select2('close');

            if (mode === "lihat") {
                $(dokterSelect).prop('disabled', true);
            }

            setTimeout(() => {
                console.log(dataDokter);
                dataDokter?.forEach(v => {
                    if (v.text === $(dokterSelect).select2('data')[0]?.text) {
                        QRSignatureAPI(v.id_original, qrId);
                    }
                });
            }, 500);
        }



        $('#dokter_pemeriksaan').prop('disabled', false)
        $('#dokter_pemeriksaan').select2('open')
        $('#dokter_pemeriksaan').select2('close')
        if (mode === "lihat")
            $('#dokter_pemeriksaan').prop('disabled', true)

        setTimeout(() => {
            console.log(dataDokter)
            dataDokter?.map(v => {
                if (v.text === $('#dokter_pemeriksaan').select2('data')[0].text) {
                    QRSignatureAPI(v.id_original, 'qr_dokter_pemeriksaan')
                }
            })
        }, 1000)



        // dokter img diagnostik
        const jumlahDokterdiagnostik = 30;

        for (let i = 1; i <= jumlahDokterdiagnostik; i++) {
            const dokterSelect = `#dokter_diagnostik${i}`;
            const qrId = `qr_dokter_diagnostik${i}`;

            $(dokterSelect).prop('disabled', false).select2('open').select2('close');

            if (mode === "lihat") {
                $(dokterSelect).prop('disabled', true);
            }

            setTimeout(() => {
                console.log(dataDokter);
                dataDokter?.forEach(v => {
                    if (v.text === $(dokterSelect).select2('data')[0]?.text) {
                        QRSignatureAPI(v.id_original, qrId);
                    }
                });
            }, 500);
        }


        $('#dokter_diagnostik').prop('disabled', false)
        $('#dokter_diagnostik').select2('open')
        $('#dokter_diagnostik').select2('close')
        if (mode === "lihat")
            $('#dokter_diagnostik').prop('disabled', true)

        setTimeout(() => {
            console.log(dataDokter)
            dataDokter?.map(v => {
                if (v.text === $('#dokter_diagnostik').select2('data')[0].text) {
                    QRSignatureAPI(v.id_original, 'qr_dokter_diagnostik')
                }
            })
        }, 1000)


        // dokter img penunjang
        const jumlahDokterpenunjang = 30;

        for (let i = 1; i <= jumlahDokterpenunjang; i++) {
            const dokterSelect = `#dokter_penunjang${i}`;
            const qrId = `qr_dokter_penunjang${i}`;

            $(dokterSelect).prop('disabled', false).select2('open').select2('close');

            if (mode === "lihat") {
                $(dokterSelect).prop('disabled', true);
            }

            setTimeout(() => {
                console.log(dataDokter);
                dataDokter?.forEach(v => {
                    if (v.text === $(dokterSelect).select2('data')[0]?.text) {
                        QRSignatureAPI(v.id_original, qrId);
                    }
                });
            }, 500);
        }


        $('#dokter_penunjang').prop('disabled', false)
        $('#dokter_penunjang').select2('open')
        $('#dokter_penunjang').select2('close')
        if (mode === "lihat")
            $('#dokter_penunjang').prop('disabled', true)

        setTimeout(() => {
            console.log(dataDokter)
            dataDokter?.map(v => {
                if (v.text === $('#dokter_penunjang').select2('data')[0].text) {
                    QRSignatureAPI(v.id_original, 'qr_dokter_penunjang')
                }
            })
        }, 1000)
    }

    function listDokterUmumAPI() {
        $('.dokter_umum').select2({
            ajax: {
                url: '<?= site_url('backend/admission/getKaryawan/5'); ?>',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                    }
                },
                processResults: function(data) {
                    const {
                        items,
                        more
                    } = data.data;
                    dataDokter = items
                    return {
                        results: items, // Data from PHP
                        pagination: {
                            more: more, // Check if more data is available
                        },
                    };
                },
                cache: true,

            },
            placeholder: 'Search for items...',
        })
    }
</script>