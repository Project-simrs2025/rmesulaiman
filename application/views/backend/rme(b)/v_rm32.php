<style>
	.bg-green {
		background-color: #90EE90;
	}

	.bg-yellow {
		background-color: #FFFF99;
	}

	.bg-orange {
		background-color: #FFA500;
	}

	.bg-red {
		background-color: #FF6666;
	}
</style>

<table class="table table-bordered table-sm border-dark">
	<thead class="table-secondary">
		<tr>
			<th colspan="8">SCORE DEWASA</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<th>SKORE</th>
			<th class="text-center">3</th>
			<th class="text-center">2</th>
			<th class="text-center">1</th>
			<th class="text-center">0</th>
			<th class="text-center">1</th>
			<th class="text-center">2</th>
			<th class="text-center">3</th>
		</tr>
		<tr>
			<th>KESADARAN</th>
			<td>Koma</td>
			<td>Stupor</td>
			<td>Somnolen</td>
			<td>Compos Mentis</td>
			<td>Apatis</td>
			<td>Acute Confusional states/Delirium</td>
			<td></td>
		</tr>
		<tr>
			<th>NADI</th>
			<td></td>
			<td>&lt; 40</td>
			<td>40-50</td>
			<td>51-100</td>
			<td>101-110</td>
			<td>111-129</td>
			<td>&ge; 130</td>
		</tr>
		<tr>
			<th>TEKANAN DARAH SISTOLIK</th>
			<td>&le; 70</td>
			<td>71-80</td>
			<td>81-100</td>
			<td>101-159</td>
			<td>160-199</td>
			<td>200-220</td>
			<td>&gt; 220</td>
		</tr>
		<tr>
			<th>PERNAFASAN</th>
			<td></td>
			<td>&lt; 8</td>
			<td>8</td>
			<td>9-17</td>
			<td>18-20</td>
			<td>21-29</td>
			<td>&ge; 30</td>
		</tr>
		<tr>
			<th>SUHU</th>
			<td></td>
			<td>&lt; 35 °C</td>
			<td>35.05 °-36 ° C</td>
			<td>36,05 ° -38 °C</td>
			<td>38,05 °-38,5 °C</td>
			<td>&gt; 38,5 °C</td>
			<td></td>
		</tr>
	</tbody>
</table>

<div class="row">
	<div class="table-responsive">
		<table class="table table-bordered table-sm mt-2 text-center border-dark">
			<thead class="table-secondary">
				<!--SECTION 1-->
				<tr>
					<th colspan="8">SCORE ANAK</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th>SKORE</th>
					<th class="text-center">3</th>
					<th class="text-center w-50">2</th>
					<th class="text-center w-50	">1</th>
					<th class="text-center w-50">0</th>
					<th></th>
				</tr>
				<tr>
					<th>Perilaku</th>
					<td>
						Letergik/bingung/penurunan respon terhadap nyeri
					</td>
					<td>
						sensitif
					</td>
					<td>
						Cenderung murung/diam
					</td>
					<td>
						sesuai
					</td>
					<td class="text-center align-content-start p-0" rowspan="7" style="width:50%">
						<table class="table table-bordered p-0 border-dark">
							<thead class="table-secondary">
								<tr>
									<th colspan="2" class="text-black">ALGORITMA SCORE ANAK & PEWARNAAN</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="width: 30%; background-color: #90EE90" class="text-black">
										Hijau (0-2)
									</td>
									<td>Pasien dalam kondisi stabil observasi setiap shift</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FFFF99" class="text-black">
										Kuning (3)
									</td>
									<td>
										Pengkajian ulang setiap 2 jam, dan didokumentasikan di catat perkembangan pasien
									</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FFA500" class="text-black">
										Orange (4)
									</td>
									<td>
										Perawat harus memonitor tanda vital setiap jam, dilaporkan ke dokter jaga, ke dr DPJP untuk
										rekomendasi rawat ICU
									</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FF6666" class="text-black">
										Merah (>5)
									</td>
									<td>
										Dokter jaga/intensivist/DPJP/melakukan tindakan intubasi dan perawatan selanjutnya di ICU,
										monitor vital sign dengan patient monitor
									</td>
								</tr>
							</tbody>
						</table>
					</td>
				</tr>
				<tr>
					<th rowspan="3">Kardiovaskular</th>
					<td>CRT ≥ 5 detik, abu-abu dan mottled</td>
					<td>CRT 4 detik, abu-abu</td>
					<td>CRT 3 detik, pucat</td>
					<td>CRT 1-2 detik, pink</td>
				</tr>
				<tr>
					<td>Nadi >30 kali/menit</td>
					<td>Nadi 20 kali/menit lebih tinggi</td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td>Sistolik 10 mmHg lebih tinggi/rendah</td>
					<td>Sistolik 10 mmHg lebih tinggi/rendah</td>
					<td></td>
				</tr>
				<tr></tr>
				<tr>
					<th rowspan="2">Pernafasan</th>
					<td>
						RR < 5
							</td>
					<td>
						RR < 20
							<td>
							RR > 10
					</td>
					<td>
						Normal
					</td>
				</tr>
				<tr>
					<td>Retraksi dan atau grunting/merintih</td>
					<td>Retraksi dada 20 kali di atas normal</td>
					<td>Menggunakan otot aksesori pernafasan</td>
					<td>Tidak ada retraksi</td>
				</tr>
				<tr>
					<td colspan="8" class="bg-white"></td>
				</tr>
				<!--SECTION 2-->
				<tr>
					<th>Usia</th>
					<th>Frekuensi Nadi<br>(x/menit)</th>
					<th>Tekanan Darah<br>Sistolik (mmHg)</th>
					<th>Frekuensi Nafas<br>(x/menit)</th>
					<th rowspan="7"></th>
					<td rowspan="7" style="width:50%">
						<table class="table table-bordered p-0 text-center border-dark">
							<thead class="table-secondary">
								<tr>
									<th colspan="2" class="text-black">ALGORITMA SCORE DEWASA & PEWARNAAN</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="width: 30%; background-color: #90EE90" class="text-black">
										Hijau (0-1)
									</td>
									<td>Pasien dalam kondisi stabil observasi setiap shift</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FFFF99" class="text-black">
										Kuning(2-3)
									</td>
									<td>
										Pengkajian ulang setiap 2 jam, dan didokumentasikan di catat perkembangan pasien
									</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FFA500" class="text-black">
										Orange (4-5)
									</td>
									<td>
										Perawat harus memonitor tanda vital setiap jam, dilaporkan ke dokter jaga, ke dr DPJP untuk
										rekomendasi rawat ICU
									</td>
								</tr>
								<tr>
									<td style="width: 30%; background-color: #FF6666" class="text-black">
										Merah (>6)
									</td>
									<td>
										Dokter jaga/intensivist/DPJP/melakukan tindakan intubasi dan perawatan selanjutnya di ICU,
										monitor vital sign dengan patient monitor
									</td>
								</tr>
							</tbody>
						</table>
					</td>
				</tr>
				<tr>
					<td>0-3 bulan</td>
					<td>100-180</td>
					<td>50</td>
					<td>60</td>

				</tr>
				<tr>
					<td>4-12 bulan</td>
					<td>100-180</td>
					<td>60</td>
					<td>50</td>
				</tr>
				<tr>
					<td>1-4 tahun</td>
					<td>90-160</td>
					<td>70</td>
					<td>40</td>
				</tr>
				<tr>
					<td>5-2 tahun</td>
					<td>80-140</td>
					<td>80</td>
					<td>30</td>
				</tr>
				<tr>
					<td>> 12 tahun</td>
					<td>60-130</td>
					<td>90</td>
					<td>30</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>



<h5 class="text-center mt-5">FORMULIR PEMANTAUAN EARLY WARNING SCORE (EWS)</h5>
<div class="row">
	<div class="col-6 mt-3">
		<label>Nama</label>
		<input type="text" name="nama_pasien" class="form-control border-dark">
	</div>
	<div class="col-6 mt-3">
		<label>No. RM</label>
		<input type="text" name="no_rm" class="form-control border-dark">
	</div>
	<div class="col-6 mt-3">
		<label>Dokter DPJP</label>
		<input type="text" name="nama_dokter" class="form-control border-dark">
	</div>
	<div class="col-6 mt-3">
		<div>Diagnosa</div>
		<select type="select" name="diagnosa" id="diagnosa" class="form-select w-75"></select>
	</div>
</div>

<div class="table-responsive">
	<div class="mt-5 ms-2">
		<h6>Algoritma Perhitungan</h6>
		<div class="col ms-3 form-group mt-2">
			<input class="custom-checkbox-success" type="radio" name="algoritma_ews" value="anak" checked>
			<label class="form-check-label">Anak</label>
		</div>
		<div class="col ms-3 form-group mt-2">
			<input class="custom-checkbox-success" type="radio" name="algoritma_ews" value="dewasa">
			<label class="form-check-label">Dewasa</label>
		</div>
	</div>
	<table id="ews-table" class="table table-bordered mt-2 text-center border-dark">
		<thead>
			<tr class="bg-white text-black">
				<td>No</td>
				<td>Suhu</td>
				<td>Nadi</td>
				<td>Tekanan Darah Sistolik</td>
				<td>Kesadaran</td>
				<td>Pernafasan</td>
				<td>* Kardiovaskuler</td>
				<td>* Perilaku</td>
				<td class="fw-bold">TOTAL EWS</td>
				<td class="fw-bold">WARNA EWS</td>
				<td>Inisial</td>
				<td>Paraf</td>
				<td>Tanggal</td>
				<td>Aksi</td>
			</tr>
		</thead>
		<tbody>
			<!-- Rows will be dynamically added here -->
		</tbody>
		<tfoot>
			<tr>
				<td colspan="14" class="text-start">
					<button type="button" class="btn btn-primary" id="add-row">Tambah Baris</button>
				</td>
			</tr>
		</tfoot>
	</table>
</div>


<script>
	const ewsTable = document.getElementById('ews-table');
	const tbody = ewsTable.querySelector('tbody');

	$(document).delay(1000).queue(function() {
		callMarkerManager();
	});

	$(document).ready(function() {
		addNewRow();

		document.getElementById('add-row').addEventListener('click', addNewRow);
		document.querySelectorAll('input[name="algoritma_ews"]').forEach(input => {
			input.addEventListener('change', updateTotalEWS);
		});

		let page = 1;
		$('#diagnosa').select2({
			ajax: {
				url: '<?= site_url('backend/admission/getDiagnosa'); ?>', // PHP script to fetch data
				dataType: 'json',
				delay: 250, // Delay in ms while typing
				data: function(params) {
					console.log("params", params)
					return {
						q: params.term, // Search query
						limit: 100, // Number of items per page
						offset: (page - 1) * 100, // Calculate offset
					};
				},
				processResults: function(data) {
					const {
						items,
						more
					} = data.data
					console.log(items, more)
					return {
						results: items, // Data from PHP
						pagination: {
							more: more, // Check if more data is available
						},
					};
				},
				cache: true,
			},
			placeholder: 'Search for items...',
			// minimumInputLength: 0,
		});
		$('#diagnosa').on('select2:open', function() {
			$('.select2-results__options').on('scroll', function() {
				const $this = $(this);
				if ($this.scrollTop() + $this.innerHeight() >= $this[0].scrollHeight) {
					page++; // Increment page
					$('#diagnosa').select2('data', null); // Trigger new data fetch
				}
			});
		});
	})

	function addNewRow() {
		const index = tbody.children.length + 1

		const row = document.createElement('tr');
		row.innerHTML = `
            <td>${index}</td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_suhu[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_suhu[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_nadi[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_nadi[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_sistolik[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_sistolik[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_kesadaran[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_kesadaran[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_pernafasan[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_pernafasan[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_kardiovaskuler[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_kardiovaskuler[]">
                </div>
            </td>
            <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    Jam <input type="time" class="form-control border-dark form-control border-dark-sm" name="time_perilaku[]">
                    Score EWS <input min="0" max="3" type="number" class="form-control border-dark form-control border-dark-sm" name="ews_perilaku[]">
                </div>
            </td>
            <td class="total-ews"></td>
            <td class="color-ews text-black"></td>
            <td><input style="width: 100px" type="text" class="form-control border-dark" name="inisial[]"></td>
            <td>
				<img style="width: 350px;height:200px" class="marker-image" src="<?= base_url() . 'assets/images/form/base-ttd.png' ?>" data-input-name="image_drawer_state_ttd_${index}" alt="">
				<input type="hidden" id="image_drawer_state_ttd_${index}" name="image_drawer_state_ttd_${index}" value=""/>
			</td>
            <td><input type="date" class="form-control border-dark" name="tanggal[]"></td>
            <td><button type="button" class="btn btn-danger btn-sm delete-row">Hapus</button></td>
        `;

		// Add event listeners for score inputs
		row.querySelectorAll('input[name^="ews_"]').forEach(input => {
			input.addEventListener('change', updateTotalEWS);
		});

		// Add event listener for delete button
		row.querySelector('.delete-row').addEventListener('click', function() {
			if (tbody.children.length > 1) {
				row.remove();
				updateRowNumbers();
				updateTotalEWS();
			} else {
				alert('Tidak dapat menghapus baris terakhir.');
			}
		});

		tbody.appendChild(row);
		updateRowNumbers();
		updateTotalEWS();
		callMarkerManager();
	}

	function updateRowNumbers() {
		const rows = tbody.querySelectorAll('tr');
		rows.forEach((row, index) => {
			row.cells[0].textContent = index + 1;
		});
	}

	function updateTotalEWS() {
		const algoritma_ews = document.querySelector('input[name="algoritma_ews"]:checked').value;

		const algoMap = {
			dewasa: {
				hijau: 1,
				kuning: 3,
				orange: 5,
				merah: 6
			},
			anak: {
				hijau: 2,
				kuning: 3,
				orange: 4,
				merah: 5
			}
		};

		const rows = tbody.querySelectorAll('tr');
		rows.forEach(row => {
			const scoreInputs = row.querySelectorAll('input[name^="ews_"]');
			let totalScore = 0;

			scoreInputs.forEach(input => {
				if (input.value !== '') {
					totalScore += parseInt(input.value) || 0;
				}
			});

			const totalEWSCell = row.querySelector('.total-ews');
			const colorEWSCell = row.querySelector('.color-ews');

			totalEWSCell.textContent = totalScore;

			if (totalScore <= algoMap[algoritma_ews].hijau) {
				colorEWSCell.style.backgroundColor = '#90EE90';
				colorEWSCell.textContent = 'Hijau';
			} else if (totalScore <= algoMap[algoritma_ews].kuning) {
				colorEWSCell.style.backgroundColor = '#FFFF99';
				colorEWSCell.textContent = 'Kuning';
			} else if (totalScore <= algoMap[algoritma_ews].orange) {
				colorEWSCell.style.backgroundColor = '#FFA500';
				colorEWSCell.textContent = 'Oranye';
			} else {
				colorEWSCell.style.backgroundColor = '#FF6666';
				colorEWSCell.textContent = 'Merah';
			}
		});
	}

	function cbCommon(data) {
		if (!(data instanceof Map)) {
			console.error('cbCommon expected a Map object');
			return;
		}

		const ewsTable = document.getElementById('ews-table');
		const tbody = ewsTable.querySelector('tbody');

		// Clear existing rows except the first one
		while (tbody.children.length > 1) {
			tbody.removeChild(tbody.lastChild);
		}

		// Get the number of rows to add based on the length of the first array in the Map
		const rowCount = data.values().next().value.length;

		// Add new rows based on the data
		for (let i = 1; i < rowCount; i++) {
			addNewRow();
		}

		// Populate the rows with data
		data.forEach((values, key) => {
			if (!Array.isArray(values)) {
				return
			}
			const inputs = ewsTable.querySelectorAll(`input[name="${key}[]"]`);
			values.forEach((value, index) => {
				if (inputs[index]) {
					inputs[index].value = value;
				}
			});
		});

		// Update totals and colors
		updateTotalEWS();
		populateFormFields(data);
	}
</script>